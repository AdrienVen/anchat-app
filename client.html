<!DOCTYPE html>
<html lang="en">
	<head>
		<title>AnChat - Login</title>
	</head>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.1.3/socket.io.min.js"></script>
	<script type="text/javascript">

	// Socket variables
	url = ('http://' + document.domain + ':' + location.port);
	socket = io.connect(url);
	variables = {};


	/*
	 * chatLayout - Changes the login page to the chat layout
	 */
	function chatLayout(){
		// switch out the two div elements
		document.getElementById("login_div").style.display = "none";
		document.getElementById("chat_div").style.display = "block";

		// setup chat content
		document.getElementById("chat_title").innerHTML = "Welcome to " + variables["group"]+', '+variables["name"]+ '!';
		document.getElementById("chat_subtitle").innerHTML = "You may start chatting with the members of the group.";
		document.getElementById("message_input").placeholder = "Send to " + variables["group"];
		document.getElementById("message_input").value = "";
	}

	
	/*
	 * loginLayout - Changes the chat page to the login layout
	 */
	function loginLayout() {
		// switch out the two div elements
		document.getElementById("chat_div").style.display = "none";
		document.getElementById("login_div").style.display = "block";

		// setup login content
		document.getElementById("login_title").innerHTML = "Welcome to the chat!"
		document.getElementById("login_subtitle").innerHTML = "Please choose a group to join or type the name of the group you want to create."
		document.getElementById("group_input").value = "";
		document.getElementById("username_input").value = "";
	}


	/*
	 * join - Sends a join request message to the server with a group and username
	 */
	 function join(){
		// get name and group submitted
		let group = document.getElementById("group_input").value;
		let name = document.getElementById("username_input").value;

		// ensure that non-empty values have been used
		if ((group == "") || (name == "")) {
			document.getElementById("login_title").innerHTML = "Something's wrong...";
			document.getElementById("login_subtitle").innerHTML = "Please fill out both fields.";
			return;
		}

		// submit join request to the server
		variables["group"] = group;
		variables["name"] = name;
		socket.emit( "join", {"group" : group, "name": name});
	}


	/*
	 * sendMsg - send messages from the user
	 */
	function sendMsg() {
		// create and send payload
		let payload = {
			"group":	variables["group"],
			"name":		variables["name"],
			"message": 	document.getElementById("message_input").value};
		socket.emit("recv", payload);
		
		// add message to message box
		let node = document.createElement("P");
		node.innerHTML = variables["name"] + ": " + document.getElementById("message_input").value;
		node.style.color = "blue";
		document.getElementById("messages").appendChild(node);
		
		// clear message input
		document.getElementById("message_input").value = "";
	}


	/*
	 * disconnectSelf - returns the user to the login page and notifies the server the user has exited
	 */
	function disconnectSelf() {
		// create and send payload
		let payload = {
			"group":	variables["group"],
			"name":		variables["name"] };
		socket.emit("disconnectUser", payload);

		// setup login layout
		loginLayout();
	}


	/*
	 * connectUser - adds a user from the chat and notifies the client
	 */
	 function connectUser(name) {
		let node = document.createElement("P");
		node.style.color = "black";

		// create join message depending on the client name
		if (variables["name"] == name) {
			node.innerHTML = "[SERVER]: You have joined the chat!";
		} else {
			node.innerHTML = "[SERVER]: User " + name + " has joined the chat!";
		}
		
		// add message to message box
		document.getElementById("messages").appendChild(node);
	}


	/*
	 * disconnectUser - removes a user from the chat and notifies the client
	 */
	function disconnectUser(name) {
		let node = document.createElement("P");
		node.innerHTML = "[SERVER]: User " + name + " has left the chat...";
		node.style.color = "black";
		document.getElementById("messages").appendChild(node);
	}


	// *********  SOCKET API  *********

	/*
	 * recvMsg - gets general chat messages
	 */
	socket.on("recvMsg", function(data){
		let node = document.createElement("P");
		node.innerHTML = data["name"]+':\t'+data["message"];
		node.style.color = "red";
		document.getElementById("messages").appendChild(node);
	});


	/*
	 * joinStatus - gets join group status messages and modifies interface accordingly
	 */
	socket.on("joinStatus", function(data) {
		if (data === "ok"){
			chatLayout();
		} else {
			document.getElementById("login_title").innerHTML = "Something's wrong...";
			document.getElementById("login_subtitle").innerHTML = "The name you have chosen if already taken, please select another.";
			document.getElementById("username_input").value = "";
		}
	});


	/*
	 * removeUser - gets user that disconnected and updates interface accordingly
	 */
	socket.on("removeUser", function(data) {
		disconnectUser(data["name"]);
	});


	/*
	 * addUser - gets user that connected and updates interface
	 */
	socket.on("addUser", function(data) {
		connectUser(data["name"]);
	});

	</script>

	<body>
		<div id="login_div">
			<h1 id="login_title"></h1>
			<p id ="login_subtitle"></p>
			<input id="group_input" placeholder="group name"></input>
			<input id="username_input" placeholder="username"></input>
			<input id="join_button" type="submit" value="Join" onclick="join()"></input>
		</div>

		<div id="chat_div">
			<h1 id="chat_title"></h1>
			<p id ="chat_subtitle"></p>
			<div id="messages"></div>
			<input id="message_input" placeholder="group name"></input>
			<input id="send_button" type="submit" value="Send" onclick="sendMsg()"></input>
			<input id="exit_button" type="submit" value="Exit" onclick="disconnectSelf()"></input>
		</div>
			
		<script type="text/javascript"> window.onLoad = loginLayout(); </script>
	</body>
</html>
